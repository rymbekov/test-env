name: Build Docker image

on:
  release:
    types: [published]

env:
  GIT_TAG: ${{ github.event.release.tag_name}}
  REPO_NAME: ${{ github.event.repository.name }}

jobs:
   check_tag:
     runs-on: ubuntu-latest
     outputs:
       run_other_jobs: ${{ steps.check-tag.outputs.result }}
     steps:
        - name: check tag ${{ github.ref }}
          id: check-tag
          uses: actions/github-script@v5
          with:
            result-encoding: string
            script: |
             const pattern = new RegExp('^[0-9]+\.[0-9]+\.[0-9]+(-(?!npm).+)*$')
             console.log(process.env.GIT_TAG)
             return pattern.test(process.env.GIT_TAG) ? "true" : "false"
            
   Build:
     name: Build Docker image
     needs: [check_tag]
     if: needs.check_tag.outputs.run_other_jobs == 'true'
     runs-on: ubuntu-20.04
     steps:
        - uses: actions/checkout@v3
        # - name: Use node.js 14
        #   uses: actions/setup-node@v3
        #   with:
        #     node-version: '14'
        #     registry-url: 'https://registry.npmjs.org'
        #   env:
        #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v1
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: us-east-1
        - name: Build docker image for service
          run: ./scripts/build.sh test $GIT_TAG true
        - uses: ./.github/actions/slack
          with:
            SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
            SLACK_SUCCESS_MESSAGE: "ðŸ“¦ Docker image *${{ env.REPO_NAME }}@${{ env.GIT_TAG }}* created! (by ${{ github.actor }})!"